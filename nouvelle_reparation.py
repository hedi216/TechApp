import streamlit as st
from db import get_connection

def app():
    st.title("‚ûï Ajouter une nouvelle r√©paration")

    with st.form("form_reparation"):
        type_appareil = st.selectbox("Type d'appareil", ["T√©l√©phone", "Tablette", "PC", "PlayStation", "Autre"])
        os = st.selectbox("Syst√®me d'exploitation", ["Android", "iOS", "Windows", "Linux", "Autre"])
        modele = st.text_input("Mod√®le de l'appareil")
        panne = st.text_area("Description de la panne")

        montant_total = st.number_input("Montant total (TND)", min_value=0.0, step=1.0)
        acompte = st.number_input("Acompte vers√© (TND)", min_value=0.0, step=1.0)
        paiement_effectue = st.radio("Paiement effectu√© ?", ["Oui", "Non"])
        type_paiement = st.selectbox("Type de paiement", ["Esp√®ces", "Carte", "Virement", "Autre"])

        submit = st.form_submit_button("üíæ Enregistrer")

    if submit:
        try:
            conn = get_connection()
            cursor = conn.cursor()

            insert_query = """
            INSERT INTO reparations (
                type_appareil, os, panne, modele,
                montant_total, acompte, paiement_effectue, type_paiement
            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
            """
            values = (
                type_appareil, os, panne, modele,
                montant_total, acompte,
                True if paiement_effectue == "Oui" else False,
                type_paiement
            )
            cursor.execute(insert_query, values)
            conn.commit()

            dernier_id = cursor.lastrowid
            code_reparation = f"R-{dernier_id:07d}"

            update_query = "UPDATE reparations SET code_reparation = %s WHERE id = %s"
            cursor.execute(update_query, (code_reparation, dernier_id))
            conn.commit()

            st.success(f"‚úÖ R√©paration enregistr√©e avec le code **{code_reparation}**")
        
        except Exception as e:
            st.error(f"‚ùå Erreur lors de l'enregistrement : {e}")
        
        finally:
            cursor.close()
            conn.close()
